---
import Layout from "../layouts/Layout.astro";
import { AppHeader } from "../components/AppHeader";
import { ProjectList } from "../components/dashboard/ProjectList";
import { getUserProjects } from "../api/services/projects/getUserProjects";
import { devLog } from "../api/utils";
import type { ProjectDto, User } from "../types";

// Check if user is authenticated
if (!Astro.locals.session) {
  return Astro.redirect("/login");
}

const authUser = Astro.locals.session.user;

// Get user data with role information
let { data: userData, error: userError } = await Astro.locals.supabase
  .from("users")
  .select("*")
  .eq("id", authUser.id)
  .single();

// If user doesn't exist in public.users table, create it
if (userError?.code === "PGRST116" || !userData) {
  const { data: newUser, error: insertError } = await Astro.locals.supabase
    .from("users")
    .insert({
      id: authUser.id,
      role: "team_member",
    })
    .select()
    .single();

  if (insertError) {
    devLog("error", "Failed to create user profile:", insertError);
    return new Response("Failed to create user profile", { status: 500 });
  }

  userData = newUser;
}

const user = userData as User;

// Get user projects
let initialProjects: ProjectDto[] = [];
try {
  initialProjects = await getUserProjects({
    userId: authUser.id,
    supabase: Astro.locals.supabase,
  });
} catch (error) {
  devLog("error", "Failed to fetch user projects:", error);
}
---

<Layout title="Projekty - 10x Project">
  <AppHeader user={user} userEmail={authUser.email} slot="header" client:load />

  <main class="min-h-screen bg-gray-50 py-6 md:py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <ProjectList client:load initialProjects={initialProjects} user={user} />
    </div>
  </main>
</Layout>
